CREATE OR REPLACE MATERIALIZED VIEW your_schema.compute_costs_mv
AS
WITH
workspace_mapping AS (
  SELECT DISTINCT workspace_id, workspace_name
  FROM platform.account.workspaces
),

clusters AS (
  SELECT DISTINCT workspace_id, cluster_id, cluster_name
  FROM system.compute.clusters
),

job_metadata AS (
  SELECT
    workspace_id,
    cluster_id,
    COUNT(DISTINCT job_id) AS all_computes_job_count,
    COLLECT_LIST(NAMED_STRUCT('job_id', job_id, 'job_name', job_name)) AS jobs_list,
    FIRST(creator_id, TRUE) AS creator_id
  FROM system.jobs
  WHERE start_time >= DATEADD(DAY, -365, CURRENT_DATE)
  GROUP BY workspace_id, cluster_id
),

user_display_names AS (
  SELECT DISTINCT identity, display_name
  FROM platform.account.users
),

sp_display_names AS (
  SELECT DISTINCT application_id AS identity, display_name
  FROM platform.account.service_principals
),

-- SQL Warehouse costs
sql_costs AS (
  SELECT
    COALESCE(wm.workspace_name, u.workspace_id) AS workspace_name,
    DATE(u.usage_end_time) AS event_date,
    'SQL' AS job_or_query,
    u.sku_name,
    NULL AS job_id,
    NULL AS run_id,
    u.usage_metadata.statement_id,
    u.usage_metadata.client_application,
    SUM(u.usage_quantity) AS dbus_usage,
    ROUND(SUM(u.usage_quantity * pb.discount_price), 2) AS cost_usd,
    u.usage_metadata.executed_by AS executed_by,
    COALESCE(
      FIRST(u_disp.display_name, TRUE),
      FIRST(sp_disp.display_name, TRUE),
      '_REDACTED_'
    ) AS job_owner,
    NULL AS job_status,
    NULL AS termination_code,
    NULL AS all_computes_job_count,
    NULL AS job_name,
    NULL AS jobs_list,
    NULL AS cluster_id,
    NULL AS cluster_name
  FROM system.billing.usage u
    LEFT JOIN platform.account.pricing_by_date pb
      ON pb.product_code = u.sku_name
      AND pb.price_date = CURRENT_DATE()
    LEFT JOIN workspace_mapping wm
      ON u.workspace_id = wm.workspace_id
    LEFT JOIN user_display_names u_disp
      ON u.usage_metadata.executed_by = u_disp.identity
    LEFT JOIN sp_display_names sp_disp
      ON u.usage_metadata.executed_by = sp_disp.identity
  WHERE
    u.sku_name LIKE '%SQL_WAREHOUSE%'
    AND u.usage_start_time >= DATEADD(DAY, -365, CURRENT_DATE)
    AND u.usage_end_time <= CURRENT_DATE()
  GROUP BY
    COALESCE(wm.workspace_name, u.workspace_id),
    DATE(u.usage_end_time),
    u.sku_name,
    u.usage_metadata.statement_id,
    u.usage_metadata.client_application,
    u.usage_metadata.executed_by
),

-- All Purpose Compute costs
apc_costs AS (
  SELECT
    COALESCE(wm.workspace_name, u.workspace_id) AS workspace_name,
    DATE(u.usage_end_time) AS event_date,
    'ALL_PURPOSE' AS job_or_query,
    u.sku_name,
    NULL AS job_id,
    NULL AS run_id,
    NULL AS statement_id,
    NULL AS client_application,
    SUM(u.usage_quantity) AS dbus_usage,
    ROUND(SUM(u.usage_quantity * pb.discount_price), 2) AS cost_usd,
    NULL AS executed_by,
    COALESCE(
      FIRST(u_disp.display_name, TRUE),
      FIRST(sp_disp.display_name, TRUE),
      '_REDACTED_'
    ) AS job_owner,
    NULL AS job_status,
    NULL AS termination_code,
    COALESCE(j.all_computes_job_count, 0) AS all_computes_job_count,
    NULL AS job_name,
    COALESCE(j.jobs_list, ARRAY()) AS jobs_list,
    u.usage_metadata.cluster_id AS cluster_id,
    FIRST(c.cluster_name, TRUE) AS cluster_name
  FROM system.billing.usage u
    LEFT JOIN platform.account.pricing_by_date pb
      ON pb.product_code = u.sku_name
      AND pb.price_date = CURRENT_DATE()
    LEFT JOIN clusters c
      ON u.workspace_id = c.workspace_id
      AND u.usage_metadata.cluster_id = c.cluster_id
    LEFT JOIN job_metadata j
      ON u.workspace_id = j.workspace_id
      AND u.usage_metadata.cluster_id = j.cluster_id
    LEFT JOIN user_display_names u_disp
      ON j.creator_id = u_disp.identity
    LEFT JOIN sp_display_names sp_disp
      ON j.creator_id = sp_disp.identity
    LEFT JOIN workspace_mapping wm
      ON u.workspace_id = wm.workspace_id
  WHERE
    u.sku_name LIKE '%ALL_PURPOSE_COMPUTE%'
    AND u.usage_start_time >= DATEADD(DAY, -365, CURRENT_DATE)
    AND u.usage_end_time <= CURRENT_DATE()
    AND u.usage_metadata.cluster_id IS NOT NULL
  GROUP BY
    COALESCE(wm.workspace_name, u.workspace_id),
    DATE(u.usage_end_time),
    u.usage_metadata.cluster_id,
    j.all_computes_job_count,
    j.jobs_list,
    j.creator_id,
    u.sku_name
),

-- Job Compute costs
job_costs AS (
  SELECT
    COALESCE(wm.workspace_name, u.workspace_id) AS workspace_name,
    DATE(u.usage_end_time) AS event_date,
    'JOBS' AS job_or_query,
    u.sku_name,
    u.usage_metadata.job_id AS job_id,
    u.usage_metadata.run_id AS run_id,
    NULL AS statement_id,
    NULL AS client_application,
    SUM(u.usage_quantity) AS dbus_usage,
    ROUND(SUM(u.usage_quantity * pb.discount_price), 2) AS cost_usd,
    u.usage_metadata.run_as AS executed_by,
    COALESCE(
      FIRST(u_disp.display_name, TRUE),
      FIRST(sp_disp.display_name, TRUE),
      '_REDACTED_'
    ) AS job_owner,
    FIRST(u.usage_metadata.status, TRUE) AS job_status,
    FIRST(u.usage_metadata.termination_code, TRUE) AS termination_code,
    NULL AS all_computes_job_count,
    FIRST(u.usage_metadata.job_name, TRUE) AS job_name,
    NULL AS jobs_list,
    NULL AS cluster_id,
    NULL AS cluster_name
  FROM system.billing.usage u
    LEFT JOIN platform.account.pricing_by_date pb
      ON pb.product_code = u.sku_name
      AND pb.price_date = CURRENT_DATE()
    LEFT JOIN workspace_mapping wm
      ON u.workspace_id = wm.workspace_id
    LEFT JOIN user_display_names u_disp
      ON u.usage_metadata.run_as = u_disp.identity
    LEFT JOIN sp_display_names sp_disp
      ON u.usage_metadata.run_as = sp_disp.identity
  WHERE
    u.sku_name LIKE '%JOB_COMPUTE%'
    AND u.usage_start_time >= DATEADD(DAY, -365, CURRENT_DATE)
    AND u.usage_end_time <= CURRENT_DATE()
  GROUP BY
    COALESCE(wm.workspace_name, u.workspace_id),
    DATE(u.usage_end_time),
    u.usage_metadata.job_id,
    u.usage_metadata.run_id,
    u.usage_metadata.run_as,
    u.sku_name
)

SELECT * FROM sql_costs
UNION ALL
SELECT * FROM apc_costs
UNION ALL
SELECT * FROM job_costs;
